name: CI/CD Podman (DB on server)

on:
  push:
    branches: [ main ]

env:
  REGISTRY: ghcr.io

jobs:
  build-and-push:
    runs-on: self-hosted
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Set IMAGE (lowercase)
        shell: bash
        run: echo "IMAGE=${REGISTRY}/${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV

      - name: Login to GHCR (podman)
        shell: bash
        run: |
          echo "${{ secrets.GHCR_TOKEN }}" | podman login ghcr.io -u "${{ secrets.GHCR_USER }}" --password-stdin

      - name: Build and push builder image (for tests)
        shell: bash
        run: |
          podman build -f docker/Dockerfile --target builder -t $IMAGE:test-${{ github.sha }} docker
          podman push $IMAGE:test-${{ github.sha }}

      - name: Build and push runtime image
        shell: bash
        run: |
          podman build -f docker/Dockerfile --target runtime -t $IMAGE:runtime-${{ github.sha }} docker
          podman push $IMAGE:runtime-${{ github.sha }}

  test:
    runs-on: self-hosted
    needs: build-and-push
    steps:
      - name: Run tests on this server (uses server Postgres on 127.0.0.1:5432)
        shell: bash
        run: |
          set -euo pipefail
          IMAGE="${REGISTRY}/${GITHUB_REPOSITORY,,}"
          IMAGE_TEST="$IMAGE:test-${{ github.sha }}"

          echo "${{ secrets.GHCR_TOKEN }}" | podman login ghcr.io -u "${{ secrets.GHCR_USER }}" --password-stdin
          podman pull "$IMAGE_TEST"

          podman run --rm --name python-app-test --network host \
            -e PYTHONPATH=/app \
            -w /app \
            "$IMAGE_TEST" pytest -v

          podman rmi "$IMAGE_TEST" >/dev/null 2>&1 || true

  deploy:
    runs-on: self-hosted
    needs: test
    steps:
      - name: Deploy runtime on this server (host network, port 8052)
        shell: bash
        run: |
          set -euo pipefail
          IMAGE="${REGISTRY}/${GITHUB_REPOSITORY,,}"
          IMAGE_RUNTIME="$IMAGE:runtime-${{ github.sha }}"

          echo "${{ secrets.GHCR_TOKEN }}" | podman login ghcr.io -u "${{ secrets.GHCR_USER }}" --password-stdin
          podman pull "$IMAGE_RUNTIME"

          podman stop python-app >/dev/null 2>&1 || true
          podman rm -f python-app >/dev/null 2>&1 || true

          podman run -d --name python-app \
            --network host \
            --restart=always \
            -e PYTHONPATH=/app \
            "$IMAGE_RUNTIME"