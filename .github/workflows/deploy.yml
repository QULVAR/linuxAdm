name: CI/CD Podman Python App with GHCR (DB on server)

on:
  push:
    branches: [ main ]

env:
  REGISTRY: ghcr.io

jobs:
  build-and-push:
    runs-on: self-hosted
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      
      - name: Set IMAGE (lowercase)
        shell: bash
        run: echo "IMAGE=ghcr.io/${GITHUB_REPOSITORY,,}" >> $GITHUB_ENV
        
      - name: Log in to GHCR (podman)
        shell: bash
        run: |
          echo "${{ secrets.GHCR_TOKEN }}" | podman login ghcr.io -u "${{ secrets.GHCR_USER }}" --password-stdin

      - name: Build and push builder image (for tests)
        shell: bash
        run: |
          podman build -f docker/Dockerfile --target builder -t $IMAGE:test-${{ github.sha }} docker
          podman push $IMAGE:test-${{ github.sha }}

      - name: Build and push runtime image
        shell: bash
        run: |
          podman build -f docker/Dockerfile --target runtime -t $IMAGE:runtime-${{ github.sha }} docker
          podman push $IMAGE:runtime-${{ github.sha }}

  test:
    runs-on: self-hosted
    needs: build-and-push
    steps:
      - name: Run tests on server via SSH (uses server's Postgres on 127.0.0.1:5432)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_SSH_PORT }}
          script: |
            set -euo pipefail

            IMAGE="${{ env.REGISTRY }}/${{ github.repository }}"
            IMAGE="$(echo "$IMAGE" | tr '[:upper:]' '[:lower:]')"
            IMAGE_TEST="$IMAGE:test-${{ github.sha }}"

            echo "${{ secrets.GHCR_TOKEN }}" | podman login ghcr.io -u "${{ secrets.GHCR_USER }}" --password-stdin
            podman pull "$IMAGE_TEST"

            # ТЕСТЫ пойдут в 127.0.0.1:5432 => нужен host network
            podman run --rm --name python-app-test --network host "$IMAGE_TEST" pytest -v

            podman rmi "$IMAGE_TEST" >/dev/null 2>&1 || true

  deploy:
    runs-on: self-hosted
    needs: test
    steps:
      - name: Deploy runtime image via SSH (uses server's Postgres on 127.0.0.1:5432)
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          port: ${{ secrets.SERVER_SSH_PORT }}
          script: |
            set -euo pipefail

            IMAGE="${{ env.REGISTRY }}/${{ github.repository }}"
            IMAGE="$(echo "$IMAGE" | tr '[:upper:]' '[:lower:]')"
            IMAGE_RUNTIME="$IMAGE:runtime-${{ github.sha }}"

            echo "${{ secrets.GHCR_TOKEN }}" | podman login ghcr.io -u "${{ secrets.GHCR_USER }}" --password-stdin
            podman pull "$IMAGE_RUNTIME"

            podman stop python-app >/dev/null 2>&1 || true
            podman rm -f python-app >/dev/null 2>&1 || true

            # ВАЖНО: host network, иначе 127.0.0.1 будет "внутри контейнера", а не на сервере
            # Порт 8052 будет открыт на сервере напрямую (проброс -p тут не нужен)
            podman run -d --name python-app \
              --network host \
              --restart=always \
              "$IMAGE_RUNTIME"

            # (опционально) чистка старых runtime-образов
            podman images --format "{{.Repository}}:{{.Tag}}" \
              | grep "$(echo "$IMAGE" | sed 's/\//\\\//g'):" \
              | grep "runtime-" \
              | grep -v "${{ github.sha }}" \
              | xargs -r podman rmi -f || true